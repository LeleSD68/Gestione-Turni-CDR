<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planner Turni Interattivo</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
     <!-- LIBRERIE PER ESPORTAZIONE PDF AVANZATA E CATTURA IMMAGINE -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* Stili per il pannello di personalizzazione griglia */
        .grid-customization-panel {
            transition: all 0.3s ease;
        }
        
        .grid-customization-toggle {
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
        }
        
        .grid-customization-toggle:hover {
            background-color: #f3f4f6;
        }
        
        .grid-control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .grid-preset-btn {
            transition: all 0.2s ease;
        }
        
        .grid-preset-btn.active {
            background-color: #4f46e5 !important;
            color: white !important;
        }
        
        /* Variabili CSS per la personalizzazione dinamica */
        :root {
            --grid-density: 1;
            --text-scale: 1;
            --table-gap: 1px;
            --border-radius: 4px;
        }
        
        /* Applicazione delle variabili alla tabella */
        #planner-table {
            transform: scale(var(--grid-density));
            transform-origin: top left;
            font-size: calc(0.875rem * var(--text-scale));
            border-spacing: var(--table-gap);
        }
        
        #planner-table td,
        #planner-table th {
            border-radius: var(--border-radius);
        }
        
        /* Preset specifici */
        .grid-ultra-compact {
            --grid-density: 0.7;
            --text-scale: 0.8;
            --table-gap: 0px;
            --border-radius: 2px;
        }
        
        .grid-spacious {
            --grid-density: 1.2;
            --text-scale: 1.1;
            --table-gap: 2px;
            --border-radius: 6px;
        }
    </style>
</head>
<body class="h-screen flex flex-col">
    
    <div id="splash-screen" class="fixed inset-0 z-[200] flex flex-col items-center justify-center text-white">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 mb-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
        <h1 id="splash-title" class="text-5xl font-bold tracking-wider">GESTIONE TURNI</h1>
        <p class="mt-4 text-lg">Caricamento in corso...</p>
        <p id="splash-version" class="mt-2 text-sm opacity-80"></p>
    </div>

    <button id="sidebar-tab">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
    </button>
    <div id="sidebar">
        <div class="sidebar-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-100">Menu Ausiliario</h2>
                <button id="sidebar-close-btn" class="text-gray-300 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <hr class="sidebar-divider">

            <h3 class="sidebar-heading">Azioni Rapide</h3>
            <div class="flex flex-col gap-2">
                <button id="update-online-sheet-btn" class="btn-3d bg-green-500 text-white hover:bg-green-600 flex items-center justify-center gap-2 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                    <span>Aggiorna File Online</span>
                </button>
                <button id="assign-mode-btn" class="btn-3d btn-purple flex items-center justify-center gap-2 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                    <span>Assegna Incarichi</span>
                </button>
                <button id="export-pdf-extra-btn" class="btn-3d btn-orange flex items-center justify-center gap-2 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                    <span>Esporta PDF Extra</span>
                </button>
                <button id="export-html-share-btn" class="btn-3d bg-teal-500 text-white hover:bg-teal-600 flex items-center justify-center gap-2 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                        <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.27 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                    </svg>
                    <span>Esporta HTML</span>
                </button>
                <button id="export-pdf-btn" class="btn-3d bg-red-500 text-white hover:bg-red-600 flex items-center justify-center gap-2 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                       <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                    </svg>
                    <span>Esporta PDF Planner</span>
                </button>
                <button id="export-pdf-assignments-btn" class="btn-3d bg-rose-500 text-white hover:bg-rose-600 flex items-center justify-center gap-2 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                       <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" /></svg>
                    <span>Esporta PDF Incarichi</span>
                </button>
                <button id="print-btn" class="btn-3d btn-gray flex items-center justify-center gap-2 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" /></svg>
                    <span>Stampa</span>
                </button>
                <button id="help-btn" class="btn-3d btn-gray flex items-center justify-center gap-2 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <span>Guida Rapida</span>
                </button>
            </div>
        </div>
    </div>
    
    <div id="app" class="p-4 md:p-6 max-w-full mx-auto w-full flex-col flex-grow hidden">

        <header id="main-header" class="mb-4 shrink-0 p-2 rounded-lg bg-white shadow-sm border">
             <div class="flex items-center justify-between gap-4 w-full">
                <div class="flex items-center gap-4 flex-shrink-0">
                    <div class="flex items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        <h1 class="text-xl font-bold text-gray-900 whitespace-nowrap">Gestione Turni</h1>
                    </div>
                    <div class="flex items-center gap-2 justify-center">
                        <button id="prev-month" class="btn-3d btn-indigo w-9 h-9 flex-shrink-0 flex items-center justify-center">&lt;</button>
                        <h2 id="current-month-year" class="text-lg font-bold text-center w-40"></h2>
                        <button id="next-month" class="btn-3d btn-indigo w-9 h-9 flex-shrink-0 flex items-center justify-center">&gt;</button>
                        <button id="today-btn" class="btn-3d btn-gray h-9 ml-1 text-sm" title="Vai al mese corrente">Oggi</button>
                    </div>
                </div>

                <nav id="main-nav" class="flex items-center gap-2 border-l border-r px-4 ml-4 flex-grow justify-center">
                    <a href="#" class="header-nav-link" data-tab="dashboard">Dashboard</a>
                    <a href="#" class="header-nav-link" data-tab="planner">Planner</a>
                    <a href="#" class="header-nav-link" data-tab="report">Report</a>
                    <a href="#" class="header-nav-link" data-tab="log-cambi">Log Cambi</a>
                    <a href="#" class="header-nav-link" data-tab="impostazioni">Impostazioni</a>
                </nav>

                <div class="flex items-center gap-4 justify-end">
                    <button id="open-emergency-dashboard" class="relative bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-full shadow-lg z-40 transition-all duration-300" title="Dashboard Emergenze">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                    </button>
                    <button id="open-backup-panel" class="relative bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-full shadow-lg z-40 transition-all duration-300" title="Gestione Backup">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4a3 3 0 00-3 3v6a3 3 0 003 3h10a3 3 0 003-3V7a3 3 0 00-3-3H5zm-1 9v-1h12v1a1 1 0 01-1 1H6a1 1 0 01-1-1zm12-3H4V7a1 1 0 011-1h10a1 1 0 011 1v3z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
             </div>
        </header>

        <div id="swap-notification-bar" class="hidden fixed top-24 left-1/2 -translate-x-1/2 z-[60] w-full max-w-4xl bg-indigo-100 p-3 rounded-lg shadow-lg border border-indigo-300 transition-all duration-300">
            <div id="swap-message" class="text-center text-indigo-800 font-semibold text-sm md:text-base"></div>
        </div>

        <main class="flex-grow overflow-y-auto relative">
            <div id="dashboard" class="tab-content p-2 hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div id="dashboard-widget-ore-lavorate" class="dashboard-widget"></div>
                    <div id="dashboard-widget-ore-extra" class="dashboard-widget"></div>
                    <div id="dashboard-widget-violazioni" class="dashboard-widget"></div>
                    <div id="dashboard-widget-costo-extra" class="dashboard-widget"></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-4 rounded-lg shadow-sm border h-96">
                        <h3 class="font-bold text-gray-700 text-center mb-2">Distribuzione Turni del Mese</h3>
                        <canvas id="dashboard-chart-turni"></canvas>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm border h-96">
                         <h3 class="font-bold text-gray-700 text-center mb-2">Equità Notti e Weekend</h3>
                        <canvas id="dashboard-chart-equita"></canvas>
                    </div>
                </div>
            </div>

            <div id="planner" class="tab-content hidden h-full flex flex-col">
                <div id="planner-toolbar" class="flex items-center justify-between p-2 mb-2 bg-gray-50 rounded-lg border shadow-sm">
                    <!-- Contenitore unico per tutti gli strumenti -->
                    <div class="flex items-center gap-4 flex-grow">
                
                        <!-- GRUPPO INTERRUTTORI -->
                        <div id="view-options-container" class="flex items-center gap-3">
                            <div class="header-toggle-group" title="Attiva/Disattiva Colori Turno sullo sfondo">
                                <label for="theme-toggle" class="header-toggle-label">Sfondi</label>
                                <label class="flex items-center cursor-pointer">
                                    <div class="relative">
                                        <input type="checkbox" id="theme-toggle" class="sr-only">
                                        <div class="toggle-bg-sm"></div>
                                    </div>
                                </label>
                            </div>
                            <div class="header-toggle-group" title="Attiva/Disattiva Effetto 3D">
                                <label for="threed-effect-toggle" class="header-toggle-label">3D</label>
                                <label class="flex items-center cursor-pointer">
                                    <div class="relative">
                                        <input type="checkbox" id="threed-effect-toggle" class="sr-only" checked>
                                        <div class="toggle-bg-sm"></div>
                                    </div>
                                </label>
                            </div>
                            <div class="header-toggle-group" title="Mostra/Nascondi Simboli Modifica">
                                <label for="mod-symbols-toggle" class="header-toggle-label">Simb.</label>
                                <label class="flex items-center cursor-pointer">
                                    <div class="relative">
                                        <input type="checkbox" id="mod-symbols-toggle" class="sr-only" checked>
                                        <div class="toggle-bg-sm"></div>
                                    </div>
                                </label>
                            </div>
                            <div class="header-toggle-group" title="Mostra/Nascondi Cornici Incarichi">
                                <label for="assignments-toggle" class="header-toggle-label">Inc.</label>
                                <label class="flex items-center cursor-pointer">
                                    <div class="relative">
                                        <input type="checkbox" id="assignments-toggle" class="sr-only" checked>
                                        <div class="toggle-bg-sm"></div>
                                    </div>
                                </label>
                            </div>
                            <div class="header-toggle-group" title="Mostra/Nascondi Ore del Turno">
                                <label for="show-hours-toggle" class="header-toggle-label">Ore</label>
                                <label class="flex items-center cursor-pointer">
                                    <div class="relative">
                                        <input type="checkbox" id="show-hours-toggle" class="sr-only">
                                        <div class="toggle-bg-sm"></div>
                                    </div>
                                </label>
                            </div>
                            <div class="header-toggle-group" title="Mostra/Nascondi Riepilogo Copertura">
                                <label for="coverage-toggle" class="header-toggle-label">Copertura</label>
                                <label class="flex items-center cursor-pointer">
                                    <div class="relative">
                                        <input type="checkbox" id="coverage-toggle" class="sr-only" checked>
                                        <div class="toggle-bg-sm"></div>
                                    </div>
                                </label>
                            </div>
                            <div class="header-toggle-group" id="performance-toggle-wrapper" title="Mostra/Nascondi Barre Performance">
                                <label for="performance-bars-toggle" class="header-toggle-label">Perf.</label>
                                <label class="flex items-center cursor-pointer">
                                    <div class="relative">
                                        <input type="checkbox" id="performance-bars-toggle" class="sr-only" checked>
                                        <div class="toggle-bg-sm"></div>
                                    </div>
                                </label>
                            </div>
                            <div class="header-toggle-group" title="Mostra solo i turni originali della matrice">
                                <label for="matrix-view-toggle" class="header-toggle-label">Matrice</label>
                                <label class="flex items-center cursor-pointer">
                                    <div class="relative">
                                        <input type="checkbox" id="matrix-view-toggle" class="sr-only">
                                        <div class="toggle-bg-sm"></div>
                                    </div>
                                </label>
                            </div>

                        </div>
                        
                        <!-- Separatore -->
                        <div class="h-6 w-px bg-gray-300"></div>
                
                        <!-- GRUPPO PRESET -->
                        <div id="view-presets" class="flex items-center gap-1" title="Preset di visualizzazione">
                            <button data-preset="planning" class="btn-3d btn-gray h-8 text-xs px-2">Pianifica</button>
                            <button data-preset="review" class="btn-3d btn-gray h-8 text-xs px-2">Revisore</button>
                            <button data-preset="clean" class="btn-3d btn-gray h-8 text-xs px-2">Pulita</button>
                        </div>
                
                        <!-- Elemento spaziatore che spinge i filtri a destra -->
                        <div class="flex-grow"></div>
                
                        <!-- PULSANTE ORGANIZZAZIONE RIMOSSO -->
                        <!-- 
                        <button id="organization-panel-toggle" class="btn-3d bg-purple-500 text-white hover:bg-purple-600 h-8 text-xs px-2 mr-2" onclick="openOrganizationPanel()" title="Filtri, ordinamenti e organizzazione del planner">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="mr-1">
                                <path d="M3 18h6v-2H3v2zM3 6v2h18V6H3zm0 7h12v-2H3v2z"/>
                            </svg>
                            Organizza
                        </button>
                        -->
                        
                        <!-- PULSANTE PERSONALIZZA GRIGLIA -->
                        <button id="grid-customization-toggle" class="grid-customization-toggle btn-3d btn-gray h-8 text-xs px-2 mr-2">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="mr-1">
                                <path d="M3 3h4v4H3V3zm6 0h4v4H9V3zm6 0h4v4h-4V3zM3 9h4v4H3V9zm6 0h4v4H9V9zm6 0h4v4h-4V9zM3 15h4v4H3v-4zm6 0h4v4H9v-4zm6 0h4v4h-4v-4z"/>
                            </svg>
                            Personalizza
                        </button>
                
                        <!-- GRUPPO FILTRI -->
                        <div id="legend-container" class="flex items-center justify-end gap-1">
                            <div class="legend-item" data-filter="C" title="Filtra per Cambi"><span class="legend-symbol bg-blue-500">C</span></div>
                            <div class="legend-item" data-filter="S" title="Filtra per Scambi"><span class="legend-symbol bg-orange-500">S</span></div>
                            <div class="legend-item" data-filter="E" title="Filtra per Periodi"><span class="legend-symbol bg-green-500">E</span></div>
                            <div class="legend-item" data-filter="+" title="Filtra per Straordinari e mostra dettagli"><span class="legend-symbol bg-red-500">+</span></div>
                            <div class="legend-item" data-filter="G" title="Filtra per Chiamate a Gettone"><span class="legend-symbol bg-yellow-500 text-black">G</span></div>
                        </div>
                    </div>
                </div>

                <!-- PANNELLO PERSONALIZZAZIONE GRIGLIA -->
                <div id="grid-customization-panel" class="grid-customization-panel bg-white p-4 rounded-lg shadow-sm border mb-2" style="display: none;">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-semibold text-gray-800">Personalizza Griglia</h3>
                        <button id="grid-reset-btn" class="text-sm text-gray-500 hover:text-gray-700">Reset</button>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="grid-control-group">
                            <label class="block text-xs font-medium text-gray-600 mb-1">Densità:</label>
                            <input type="range" id="grid-density-slider" class="w-full" min="0" max="2" step="0.1" value="1">
                            <span id="grid-density-value" class="text-xs text-gray-500">1.0</span>
                        </div>
                        
                        <div class="grid-control-group">
                            <label class="block text-xs font-medium text-gray-600 mb-1">Dimensione Testo:</label>
                            <input type="range" id="text-scale-slider" class="w-full" min="1" max="3" step="0.1" value="1.5">
                            <span id="text-scale-value" class="text-xs text-gray-500">1.5</span>
                        </div>
                        
                        <div class="grid-control-group">
                            <label class="block text-xs font-medium text-gray-600 mb-1">Spaziatura:</label>
                            <input type="range" id="table-gap-slider" class="w-full" min="0" max="4" step="0.5" value="1">
                            <span id="table-gap-value" class="text-xs text-gray-500">1px</span>
                        </div>
                        
                        <div class="grid-control-group">
                            <label class="block text-xs font-medium text-gray-600 mb-1">Bordi:</label>
                            <input type="range" id="border-radius-slider" class="w-full" min="0" max="10" step="1" value="4">
                            <span id="border-radius-value" class="text-xs text-gray-500">4px</span>
                        </div>
                    </div>
                    
                    <div class="grid-preset-buttons flex gap-2 mt-4">
                        <button class="grid-preset-btn btn-3d btn-gray text-xs px-3 py-1" data-preset="ultra-compact">Ultra Compatta</button>
                        <button class="grid-preset-btn btn-3d btn-indigo text-xs px-3 py-1 active" data-preset="normal">Normale</button>
                        <button class="grid-preset-btn btn-3d btn-gray text-xs px-3 py-1" data-preset="spacious">Spaziosa</button>
                        <button class="grid-preset-btn btn-3d btn-gray text-xs px-3 py-1" data-preset="custom">Personalizzata</button>
                    </div>
                </div>

                <div id="planner-container-wrapper" class="bg-white p-4 rounded-lg shadow-sm flex flex-col flex-grow">
                    <div class="table-container flex-grow relative">
                        <table id="planner-table" class="w-full text-sm text-left text-gray-500 show-coverage-summary">
                            <thead id="planner-head" class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0 z-30"></thead>
                            <tbody id="planner-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="report" class="tab-content hidden p-2">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex justify-between items-center border-b pb-4 mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Reporting e Analisi</h2>
                        <button id="print-report-btn" class="btn-3d btn-gray flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd"></path></svg>
                            <span>Stampa Report</span>
                        </button>
                    </div>

                    <div id="report-controls" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end mb-6">
                        <div>
                            <label for="report-start-date" class="block text-sm font-medium text-gray-700">Data Inizio</label>
                            <input type="date" id="report-start-date" class="modal-input">
                        </div>
                        <div>
                            <label for="report-end-date" class="block text-sm font-medium text-gray-700">Data Fine</label>
                            <input type="date" id="report-end-date" class="modal-input">
                        </div>
                        <div class="md:col-span-1">
                            <button id="generate-report-btn" class="w-full btn-3d btn-indigo">Genera Report</button>
                        </div>
                    </div>

                    <div id="report-nav" class="border-b border-gray-200 mb-4">
                        <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                            <a href="#" data-report-type="payroll" class="report-tab-link active">Riconciliazione Ore</a>
                            <a href="#" data-report-type="equity" class="report-tab-link">Analisi Equità</a>
                        </nav>
                    </div>
                    
                    <div id="report-content-area" class="mt-4">
                        <div id="report-placeholder" class="text-center py-12 text-gray-500">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V7a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">Nessun report generato</h3>
                            <p class="mt-1 text-sm text-gray-500">Seleziona un intervallo di date e clicca su "Genera Report".</p>
                        </div>
                        <div id="report-container" class="hidden"></div>
                    </div>
                </div>
            </div>
            
            <div id="impostazioni" class="tab-content hidden p-2">
                <div class="grid grid-cols-12 gap-4">
                    <!-- Colonna di Navigazione Sinistra (più stretta) -->
                    <div class="col-span-12 md:col-span-2">
                        <nav id="settings-nav" class="flex flex-col gap-2">
                            <a href="#" data-settings-tab="data" class="settings-nav-link active">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" /></svg>
                                <span>Gestione Dati</span>
                            </a>
                            <a href="#" data-settings-tab="config" class="settings-nav-link">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>
                                <span>Configurazione</span>
                            </a>
                            <a href="#" data-settings-tab="elements" class="settings-nav-link">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a1 1 0 011-1h14a1 1 0 110 2H3a1 1 0 01-1-1z" /></svg>
                                <span>Elementi di Base</span>
                            </a>
                            <a href="#" data-settings-tab="style" class="settings-nav-link">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                                <span>Aspetto e Stile</span>
                            </a>
                            <a href="#" data-settings-tab="scambi" class="settings-nav-link">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M8 5a1 1 0 100 2h5.586l-1.293 1.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L13.586 5H8zM12 15a1 1 0 100-2H6.414l1.293-1.293a1 1 0 10-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L6.414 15H12z" />
                                </svg>
                                <span>Scambio Matrici</span>
                            </a>
<a href="#" data-settings-tab="ordinamenti" class="settings-nav-link">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
        <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a1 1 0 011-1h14a1 1 0 110 2H3a1 1 0 01-1-1z" />
    </svg>
    <span>Schemi e Chiamate</span>
</a>
                        </nav>
                    </div>
            
                    <!-- Pannelli di Contenuto a Destra (più larghi) -->
                    <div class="col-span-12 md:col-span-10">
                        <div id="settings-panel-data" class="settings-content-panel space-y-4">
                            <div class="settings-card">
                                <h4 class="settings-card-title">Importa Griglia Turni</h4>
                                <p class="settings-card-description">Carica i turni da un file CSV, XLSX o da un Foglio Google pubblicato.</p>
                                <div class="mt-4 space-y-3">
                                    <div class="flex items-center gap-2">
                                        <input type="text" id="import-gsheet-url" placeholder="Incolla URL Foglio Google..." class="modal-input flex-grow">
                                        <button id="import-gsheet-btn" class="btn-3d btn-green text-sm flex-shrink-0">Importa da URL</button>
                                    </div>
                                    <button id="import-file-schedule-btn" class="w-full btn-3d btn-gray text-sm">Importa da File (.csv, .xlsx)</button>
                                    <input type="file" id="import-file-schedule-input" class="hidden" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
                                </div>
                            </div>
                            <div class="settings-card">
                                <h4 class="settings-card-title">Esporta Dati</h4>
                                <p class="settings-card-description">Salva la griglia attuale in vari formati.</p>
                                <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
                                    <button id="export-xlsx-schedule-btn" class="w-full btn-3d btn-gray text-sm">Esporta Griglia (.xlsx)</button>
                                    <button id="export-html-share-btn" class="w-full btn-3d btn-gray text-sm">Esporta Vista Web (.html)</button>
                                </div>
                            </div>
                             <div class="settings-card border-l-4 border-indigo-400">
                                <h4 class="settings-card-title text-indigo-700">Backup e Ripristino</h4>
                                <p class="settings-card-description">Salva o carica l'intero stato dell'applicazione, incluse impostazioni, operatori e turni modificati.</p>
                                <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
                                    <button id="btn-save-full-state" class="w-full btn-3d btn-indigo text-sm">Salva Stato Completo</button>
                                    <button id="btn-load-full-state" class="w-full btn-3d btn-gray text-sm">Carica Stato Completo</button>
                                    <input type="file" id="input-load-full-state" class="hidden" accept=".json">
                                </div>
                            </div>
                        </div>
                        
                        <div id="settings-panel-config" class="settings-content-panel hidden space-y-4">
                           <div class="settings-card">
                                <h4 class="settings-card-title">Copertura Ottimale</h4>
                                <p class="settings-card-description">Definisci il numero ideale di operatori per ciascun tipo di turno.</p>
                                <div id="coverage-controls" class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-3"></div>
                            </div>
                            <div class="settings-card">
                                <h4 class="settings-card-title">Regole di Validazione</h4>
                                <p class="settings-card-description">Imposta i limiti per il calcolo automatico delle violazioni.</p>
                                <div id="validation-rules-container" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="rule-minRestHours" class="rule-label">Minimo ore di riposo tra i turni</label>
                                        <input type="number" id="rule-minRestHours" value="11" class="modal-input">
                                    </div>
                                    <div>
                                        <label for="rule-maxConsecutiveDays" class="rule-label">Massimo giorni di lavoro consecutivi</label>
                                        <input type="number" id="rule-maxConsecutiveDays" value="6" class="modal-input">
                                    </div>
                                </div>
                            </div>
                        </div>
            
                        <div id="settings-panel-elements" class="settings-content-panel hidden">
                            <div class="elements-container bg-white rounded-lg shadow-sm flex flex-col">
                                <div id="elements-header" class="p-2 border-b flex-shrink-0">
                                    <nav id="elements-category-nav" class="flex space-x-1 bg-gray-100 p-1 rounded-lg"></nav>
                                </div>
                                <div class="flex-grow flex overflow-hidden">
                                    <!-- Master Panel (con scroll) -->
                                    <div id="elements-master-panel" class="w-full lg:w-2/3 border-r flex flex-col bg-gray-50">
                                        <div class="p-2 border-b flex-shrink-0">
                                            <input type="search" id="elements-search-input" placeholder="Cerca..." class="modal-input text-sm">
                                        </div>
                                        <div id="elements-master-list" class="flex-grow overflow-y-auto">
                                            <!-- La lista a griglia verrà inserita qui -->
                                        </div>
                                        <div class="p-2 border-t bg-gray-100 flex-shrink-0">
                                            <button id="elements-add-btn" class="w-full btn-3d btn-indigo text-sm">Aggiungi Nuovo</button>
                                        </div>
                                    </div>
                                    <!-- Detail Panel (con scroll gestito dal wrapper) -->
                                    <div id="elements-detail-panel" class="w-full lg:w-1/3 flex flex-col">
                                        <!-- Il dettaglio verrà renderizzato qui da JS -->
                                    </div>
                                </div>
                            </div>
                        </div>
            
                        <div id="settings-panel-style" class="settings-content-panel hidden space-y-4">
                            <div class="settings-card">
                                <h4 class="settings-card-title">Personalizza Aspetto</h4>
                                <p class="settings-card-description">Modifica i colori e scegli un tema predefinito.</p>
                                <div class="space-y-4 mt-2">
                                    <div class="flex items-center justify-between">
                                        <label for="toggle-color-picker" class="block font-medium text-gray-700">Colore Selettori e Attivazione</label>
                                        <input type="color" id="toggle-color-picker" class="w-16 h-8 p-1 border rounded-md">
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <label for="work-cell-bg-color-picker" class="block font-medium text-gray-700">Sfondo Cella di Lavoro</label>
                                        <input type="color" id="work-cell-bg-color-picker" class="w-16 h-8 p-1 border rounded-md">
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <label for="highlight-color-picker" class="block font-medium text-gray-700">Colore Evidenziazione Griglia</label>
                                        <input type="color" id="highlight-color-picker" class="w-16 h-8 p-1 border rounded-md">
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <label for="sunday-bars-toggle" class="block font-medium text-gray-700">Barre Separatrici Domeniche</label>
                                        <input type="checkbox" id="sunday-bars-toggle" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                                    </div>
                                </div>
                                <div class="mt-4 pt-4 border-t">
                                    <h5 class="font-semibold text-gray-800 mb-2">Temi Rapidi</h5>
                                    <div class="grid grid-cols-2 gap-2">
                                        <button id="theme-btn-dark" class="btn-3d btn-gray text-sm">Tema Scuro</button>
                                        <button id="theme-btn-contrast" class="btn-3d btn-gray text-sm">Alto Contrasto</button>
                                    </div>
                                </div>
                            </div>
                            <div class="settings-card border-l-4 border-red-400">
                                <h4 class="settings-card-title text-red-700">Zona Pericolosa</h4>
                                <p class="settings-card-description">Questa azione cancellerà tutte le modifiche manuali per un operatore in un dato periodo.</p>
                                <button id="clear-changes-btn" class="w-full mt-2 btn-3d btn-red flex items-center justify-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                                    <span>Cancella Modifiche in un Periodo</span>
                                </button>
                            </div>
                        </div>

                        <div id="settings-panel-scambi" class="settings-content-panel hidden space-y-4">
                            <div class="settings-card">
                                <h4 class="settings-card-title">Gestione Scambio Matrici</h4>
                                <p class="settings-card-description">Crea regole per scambiare le matrici di turno tra due operatori per un periodo di tempo definito.</p>
                            </div>
                        
                            <!-- Form per aggiungere/modificare uno scambio -->
                            <div class="settings-card">
                                <h4 id="scambio-form-title" class="settings-card-title">Aggiungi Nuovo Scambio</h4>
                                <form id="form-scambio-matrice" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                                    <input type="hidden" id="scambio-id">
                                    <div>
                                        <label for="scambio-operatore-a" class="form-field-label">Operatore A</label>
                                        <select id="scambio-operatore-a" class="modal-input" required></select>
                                    </div>
                                    <div>
                                        <label for="scambio-operatore-b" class="form-field-label">Operatore B</label>
                                        <select id="scambio-operatore-b" class="modal-input" required></select>
                                    </div>
                                    <div>
                                        <label for="scambio-start-date" class="form-field-label">Dal Giorno</label>
                                        <input type="date" id="scambio-start-date" class="modal-input" required>
                                    </div>
                                    <div>
                                        <label for="scambio-end-date" class="form-field-label">Al Giorno</label>
                                        <input type="date" id="scambio-end-date" class="modal-input" required>
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="scambio-note" class="form-field-label">Note (Opzionale)</label>
                                        <input type="text" id="scambio-note" class="modal-input" placeholder="Es. Scambio autunnale">
                                    </div>
                                    <div class="md:col-span-2 flex justify-end gap-2 mt-2">
                                        <button type="button" id="btn-cancel-scambio-edit" class="btn-3d btn-gray hidden">Annulla</button>
                                        <button type="submit" class="btn-3d btn-indigo">Salva Scambio</button>
                                    </div>
                                </form>
                            </div>
                        
                            <!-- Lista degli scambi esistenti -->
                            <div class="settings-card">
                                <h4 class="settings-card-title">Scambi Programmati</h4>
                                <div id="scambi-list" class="mt-2 space-y-2">
                                    <!-- Gli scambi verranno inseriti qui da JS -->
                                </div>
                            </div>
                        </div>

                        <div id="settings-panel-ordinamenti" class="settings-content-panel hidden space-y-4">
                            <div class="settings-card">
                                <h4 class="settings-card-title">Gestione Schemi di Ordinamento</h4>
                                <p class="settings-card-description">Visualizza ed elimina gli schemi di rotazione personalizzati che hai creato. Le nuove rotazioni vengono create tramite drag-and-drop direttamente nel planner.</p>
                            </div>
                            <div class="settings-card">
                                <h4 class="settings-card-title">Schemi Salvati</h4>
                                <div id="ordering-schemes-list" class="mt-2 space-y-2">
                                    <!-- Gli schemi verranno inseriti qui da JS -->
                                </div>
                            </div>
                            <div class="settings-card">
                                <h4 class="settings-card-title">Sistema Chiamate di Sostituzione</h4>
                                <p class="settings-card-description">Gestisci il sistema di chiamate per sostituzioni e visualizza lo storico delle operazioni.</p>
                                <div class="mt-4 space-y-3">
                                    <button id="view-call-history" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded transition-colors">
                                        📋 Visualizza Storico Chiamate
                                    </button>
                                    <button id="toggle-call-system" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded transition-colors">
                                        🔄 Attiva/Disattiva Sistema
                                    </button>
                                    <div class="text-sm text-gray-600 bg-gray-50 p-3 rounded">
                                        <p><strong>Funzionalità:</strong></p>
                                        <ul class="list-disc list-inside mt-1 space-y-1">
                                            <li>Visualizza tutte le chiamate inviate e ricevute</li>
                                            <li>Monitora lo stato delle risposte</li>
                                            <li>Disattiva temporaneamente il sistema</li>
                                            <li>Cancella lo storico quando necessario</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            
            <div id="log-cambi" class="tab-content hidden p-2">
                <div class="bg-white rounded-lg shadow-sm border p-4">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-gray-900">Registro Cambi Turni</h2>
                        <div class="flex items-center gap-2">
                            <button id="export-logs-btn" class="btn-3d btn-indigo text-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                                Esporta
                            </button>
                            <button id="clear-logs-btn" class="btn-3d btn-red text-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" clip-rule="evenodd" />
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                </svg>
                                Pulisci
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filtri -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Filtri di Ricerca</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label for="filter-start-date" class="block text-sm font-medium text-gray-700 mb-1">Data Inizio</label>
                                <input type="date" id="filter-start-date" class="modal-input">
                            </div>
                            <div>
                                <label for="filter-end-date" class="block text-sm font-medium text-gray-700 mb-1">Data Fine</label>
                                <input type="date" id="filter-end-date" class="modal-input">
                            </div>
                            <div>
                                <label for="filter-operator" class="block text-sm font-medium text-gray-700 mb-1">Operatore</label>
                                <select id="filter-operator" class="modal-input">
                                    <option value="">Tutti gli operatori</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-change-type" class="block text-sm font-medium text-gray-700 mb-1">Tipo Cambio</label>
                                <select id="filter-change-type" class="modal-input">
                                    <option value="">Tutti i tipi</option>
                                    <option value="C">Cambio Turno</option>
                                    <option value="S">Scambio</option>
                                    <option value="E">Emergenza</option>
                                    <option value="M">Modifica Extra</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <div>
                                <label for="filter-reason" class="block text-sm font-medium text-gray-700 mb-1">Motivo (ricerca testo)</label>
                                <input type="text" id="filter-reason" placeholder="Cerca per motivo..." class="modal-input">
                            </div>
                            <div class="flex items-end">
                                <button id="apply-filters-btn" class="btn-3d btn-indigo mr-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" />
                                    </svg>
                                    Applica Filtri
                                </button>
                                <button id="reset-filters-btn" class="btn-3d btn-gray">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                                    </svg>
                                    Reset
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Statistiche -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <svg class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-blue-600">Totale Cambi</p>
                                    <p id="stat-total-changes" class="text-2xl font-bold text-blue-900">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <svg class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-green-600">Scambi</p>
                                    <p id="stat-swaps" class="text-2xl font-bold text-green-900">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <svg class="h-8 w-8 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-yellow-600">Emergenze</p>
                                    <p id="stat-emergencies" class="text-2xl font-bold text-yellow-900">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <svg class="h-8 w-8 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-purple-600">Modifiche Extra</p>
                                    <p id="stat-modifications" class="text-2xl font-bold text-purple-900">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tabella Log -->
                    <div class="bg-white border rounded-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data/Ora</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Operatore</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cambio</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Motivo</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Note</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Azioni</th>
                                    </tr>
                                </thead>
                                <tbody id="logs-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- I log verranno inseriti qui dinamicamente -->
                                </tbody>
                            </table>
                        </div>
                        <div id="logs-pagination" class="bg-gray-50 px-4 py-3 flex items-center justify-between border-t border-gray-200">
                            <div class="flex-1 flex justify-between sm:hidden">
                                <button id="prev-page-mobile" class="btn-3d btn-gray text-sm">Precedente</button>
                                <button id="next-page-mobile" class="btn-3d btn-gray text-sm">Successivo</button>
                            </div>
                            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                                <div>
                                    <p class="text-sm text-gray-700">
                                        Mostrando <span id="showing-from" class="font-medium">1</span> a <span id="showing-to" class="font-medium">10</span> di <span id="total-logs" class="font-medium">0</span> risultati
                                    </p>
                                </div>
                                <div>
                                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                                        <button id="prev-page" class="btn-3d btn-gray text-sm">Precedente</button>
                                        <span id="page-numbers" class="flex"></span>
                                        <button id="next-page" class="btn-3d btn-gray text-sm">Successivo</button>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Messaggio vuoto -->
                    <div id="no-logs-message" class="hidden text-center py-12">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">Nessun cambio registrato</h3>
                        <p class="mt-1 text-sm text-gray-500">I cambi ai turni verranno visualizzati qui quando effettuati.</p>
                    </div>
                </div>
            </div>

        </main>
    </div>
    
    <div id="mod-tooltip"></div>
    
    <div id="mini-menu" class="hidden absolute z-[60] bg-white rounded-lg shadow-xl border text-sm p-2 flex flex-col gap-1 w-48">
        <a href="#" data-action="edit-notification"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg><span>Modifica</span></a>
        <hr class="my-1">
        <a href="#" data-action="change"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg><span>Cambio Turno</span></a>
        <a href="#" data-action="swap"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 01.707.293l3 3a1 1 0 01-1.414 1.414L11 6.414V12a1 1 0 11-2 0V6.414L7.707 7.707a1 1 0 01-1.414-1.414l3-3A1 1 0 0110 3zm-3.707 9.293a1 1 0 011.414 0L9 13.586V8a1 1 0 112 0v5.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg><span>Scambio</span></a>
        <a href="#" data-action="period"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg><span>Periodo</span></a>
        <a href="#" data-action="extra"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span>Extra</span></a>
        <a href="#" data-action="note"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg><span>Nota</span></a>
        <hr class="my-1">
        <a href="#" data-action="call-substitute"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg><span>Chiama Sostituto</span></a>
        <a href="#" data-action="respond-call"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 11.5V14m0-2.5v-6a1.5 1.5 0 113 0m-3 6a1.5 1.5 0 00-3 0v2a7.5 7.5 0 0015 0v-5a1.5 1.5 0 00-3 0m-6-3V11m0-5.5v-1a1.5 1.5 0 013 0v1m0 0V11m0-5.5a1.5 1.5 0 013 0v3.5M3 16.5h18" /></svg><span>Rispondi a Chiamata</span></a>
        <hr class="my-1">
        <a href="#" data-action="unavailability"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L5.636 5.636" /></svg><span>Indisponibilità</span></a>
        <a href="#" data-action="copy-week"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg><span>Copia Settimana</span></a>
        <a href="#" data-action="paste-week"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg><span>Incolla Settimana</span></a>
        <a href="#" data-action="revert" class="danger"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg><span>Ripristina</span></a>
    </div>

    <div id="assignment-palette" class="hidden absolute z-[70] bg-white rounded-lg shadow-xl border text-sm p-2 flex flex-col gap-1 w-56">
        <div id="assignment-palette-content" class="flex flex-col gap-1"></div>
        <hr class="my-1">
        <a href="#" data-action="clear" class="assignment-palette-action danger"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg><span>Annulla Colore</span></a>
        <a href="#" data-action="exit" class="assignment-palette-action"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg><span>Esci</span></a>
    </div>

    <div id="loader" class="fixed inset-0 z-[200] items-center justify-center hidden modal-backdrop"><div class="loader"></div></div>
    


    <div id="modal-cell-action" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-3xl m-4 overflow-y-auto max-h-[90vh]">
            <h3 class="text-lg font-bold mb-4 modal-draggable" id="modal-cell-title"></h3>
            <div id="change-summary" class="mb-4 p-3 bg-indigo-50 border border-indigo-200 rounded-lg text-center hidden"></div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- COLONNA SINISTRA -->
                <div class="space-y-4">
                    <!-- Sezione Cambio Turno -->
                    <div id="modal-section-change" class="modal-section modal-section-blue">
                        <h4 class="modal-section-title"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg><span>Cambia Turno</span></h4>
                        <select id="change-turno" class="modal-input"></select>
                        <div class="space-y-3 mt-4">
                            <div class="flex justify-between items-center">
                                <p class="text-sm font-medium text-gray-700">Motivo del cambio</p>
                                <button id="btn-add-new-reason-inline" class="text-xs btn-3d btn-indigo py-1 px-2">Aggiungi</button>
                            </div>
                            <div id="change-reason-container" class="reason-group space-y-2"></div>
                            <div id="sub-reason-container" class="hidden pl-6 mt-2 space-y-2 sub-reason-group"></div>
                        </div>
                        <div id="change-gettone-container" class="hidden mt-2">
                             <label class="flex items-center text-sm text-gray-700"><input type="checkbox" id="change-gettone-checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"><span class="ml-2">Attiva gettone per il cambio</span></label>
                        </div>
                        <textarea id="change-note" rows="2" class="modal-input mt-2" placeholder="Aggiungi una nota per il cambio..."></textarea>
                    </div>
                    
                    <!-- Sezione Aggiungi Extra -->
                    <div id="modal-section-extra" class="modal-section modal-section-orange">
                        <h4 class="modal-section-title"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span>Aggiungi Extra</span></h4>
                        <div id="extra-type-container" class="space-y-2 text-sm">
                            <label class="flex items-center cursor-pointer"><input type="radio" name="extra-type" value="straordinario" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"><span class="ml-2">Straordinario</span></label>
                            <label class="flex items-center cursor-pointer"><input type="radio" name="extra-type" value="prolungamento" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"><span class="ml-2">Prolungamento</span></label>
                            <label class="flex items-center cursor-pointer"><input type="radio" name="extra-type" value="rientro" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"><span class="ml-2">Rientro</span></label>
                        </div>
                        <div id="extra-details-container" class="mt-4 space-y-3 hidden">
                            <div class="grid grid-cols-2 gap-4">
                                <div><label for="extra-start-time" class="block text-xs font-medium text-gray-600">Dalle Ore</label><input type="time" id="extra-start-time" class="modal-input"></div>
                                <div><label for="extra-end-time" class="block text-xs font-medium text-gray-600">Alle Ore</label><input type="time" id="extra-end-time" class="modal-input"></div>
                            </div>
                            <div>
                                <label for="extra-hours-manual" class="block text-xs font-medium text-gray-600">Oppure inserisci ore manuali</label>
                                <input type="number" id="extra-hours-manual" step="0.5" min="0" class="modal-input" placeholder="Es. 2.5">
                            </div>
                        </div>
                        <div class="mt-4 pt-3 border-t border-orange-300">
                             <label class="flex items-center text-sm text-gray-700 font-medium"><input type="checkbox" id="extra-gettone-checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"><span class="ml-2">Attiva gettone di chiamata</span></label>
                        </div>
                        <div class="mt-4">
                            <label for="extra-note" class="block text-xs font-medium text-gray-600">Note per l'extra</label>
                            <textarea id="extra-note" rows="2" class="modal-input" placeholder="Aggiungi una nota..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- COLONNA DESTRA -->
                <div class="space-y-4">
                    <!-- Sezione Assegna Periodo -->
                    <div id="modal-section-period" class="modal-section modal-section-green">
                        <h4 class="modal-section-title"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg><span>Assegna Periodo</span></h4>
                        <div>
                            <label for="period-turno" class="block text-xs font-medium text-gray-600">Turno da Assegnare</label>
                            <select id="period-turno" class="modal-input"></select>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-2">
                            <div><label for="period-start-date" class="block text-sm font-medium text-gray-700">Dal Giorno</label><input type="date" id="period-start-date" class="modal-input"></div>
                            <div><label for="period-end-date" class="block text-sm font-medium text-gray-700">Al Giorno</label><input type="date" id="period-end-date" class="modal-input"></div>
                        </div>
                        <button id="save-assign-period" class="mt-3 w-full btn-3d btn-green text-sm">Applica sul Periodo</button>
                    </div>

                    <!-- Sezione Nota Generale -->
                    <div id="modal-section-note" class="modal-section modal-section-gray">
                        <h4 class="modal-section-title"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg><span>Nota Generale</span></h4>
                        <textarea id="add-note" rows="3" class="modal-input" placeholder="Aggiungi una nota..."></textarea>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button id="cancel-cell-action" onclick="closeModal('modal-cell-action')" class="btn-3d btn-gray">Annulla</button>
                <button id="save-cell-action" class="btn-3d btn-indigo">Salva Modifiche</button>
            </div>
        </div>
    </div>
    
    <div id="modal-swap" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl m-4">
            <h3 class="text-lg font-bold mb-4">Conferma Scambio Turni</h3>
            <div class="modal-body space-y-4">
                <p class="text-center text-gray-600 text-sm">Stai per scambiare i seguenti turni. Controlla i dati e conferma.</p>
                <div class="grid grid-cols-[1fr_auto_1fr] gap-4 items-center">
                    <div id="swap-from-details" class="bg-gray-50 p-4 rounded-lg border text-center"></div>
                    <div class="text-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-indigo-500 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg></div>
                    <div id="swap-to-details" class="bg-gray-50 p-4 rounded-lg border text-center"></div>
                </div>
                <textarea id="swap-note" class="modal-input" rows="2" placeholder="Aggiungi una nota opzionale per lo scambio..."></textarea>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button id="cancel-swap-btn" class="btn-3d btn-gray">Annulla</button>
                <button id="confirm-swap-btn" class="btn-3d btn-green">Conferma Scambio</button>
            </div>
        </div>
    </div>
    
    <div id="modal-clear-changes" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md m-4">
            <h3 class="text-lg font-bold mb-4">Cancella Modifiche in un Periodo</h3>
            <div class="space-y-4">
                <p class="text-sm text-gray-600">Ripristina i turni originali per gli operatori e il periodo selezionato.</p>
                <div><label for="clear-changes-operator" class="block text-sm font-medium text-gray-700">Operatore</label><select id="clear-changes-operator" class="modal-input"></select></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label for="clear-changes-start-date" class="block text-sm font-medium text-gray-700">Dal Giorno</label><input type="date" id="clear-changes-start-date" class="modal-input"></div>
                    <div><label for="clear-changes-end-date" class="block text-sm font-medium text-gray-700">Al Giorno</label><input type="date" id="clear-changes-end-date" class="modal-input"></div>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3"><button onclick="closeModal('modal-clear-changes')" class="btn-3d btn-gray">Annulla</button><button id="confirm-clear-changes-btn" class="btn-3d btn-red">Cancella Modifiche</button></div>
        </div>
    </div>

    <div id="modal-multi-select-action" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg m-4">
            <h3 class="text-lg font-bold mb-4">Assegnazione Multipla</h3>
            <div id="multi-select-summary" class="mb-4 text-sm text-gray-700 bg-gray-50 p-3 rounded-md border max-h-48 overflow-y-auto"></div>
            <div class="space-y-2 mt-4">
                <label for="multi-select-turno" class="block text-sm font-medium text-gray-700">Seleziona il turno da assegnare:</label>
                <select id="multi-select-turno" class="modal-input"></select>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="closeModal('modal-multi-select-action')" class="btn-3d btn-gray">Annulla</button>
                <button id="save-multi-select-action" class="btn-3d btn-indigo">Applica a Tutti</button>
            </div>
        </div>
    </div>

    <div id="modal-deactivate-choice" class="fixed inset-0 z-[100] items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md m-4">
            <h3 id="deactivate-choice-title" class="text-lg font-bold mb-4">Disattiva Operatore</h3>
            <div class="text-sm text-gray-600">
                <p>Cosa vuoi fare con questo operatore per il mese corrente?</p>
            </div>
            <div class="mt-6 flex flex-col items-stretch gap-3">
                <button id="deactivate-choice-exclude" class="btn-3d btn-orange w-full">Escludi dal Conteggio</button>
                <button id="deactivate-choice-inactive" class="btn-3d btn-red w-full">Rendi Inattivo</button>
                <button id="deactivate-choice-cancel" class="btn-3d btn-gray w-full mt-2">Annulla</button>
            </div>
        </div>
    </div>

    <div id="modal-confirm" class="fixed inset-0 z-[100] items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm m-4">
            <h3 id="confirm-modal-title" class="text-lg font-bold mb-4">Conferma Azione</h3>
            <p id="confirm-modal-message" class="text-sm text-gray-600"></p>
            <div class="mt-6 flex justify-end gap-3"><button id="confirm-modal-cancel" class="btn-3d btn-gray">Annulla</button><button id="confirm-modal-ok" class="btn-3d btn-red">Conferma</button></div>
        </div>
    </div>

    <div id="modal-extra-hours" class="fixed inset-0 z-[150] items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-4xl m-4 max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center pb-2 mb-4 border-b">
                <h3 id="extra-hours-title" class="text-xl font-bold text-gray-800">Riepilogo Ore Extra</h3>
                <div class="flex items-center gap-2">
                    <button id="print-extra-hours-btn" class="btn-3d btn-gray p-2 h-9 w-9 flex items-center justify-center" title="Stampa Riepilogo">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" /></svg>
                    </button>
                    <button onclick="closeModal('modal-extra-hours')" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                </div>
            </div>
            <div id="extra-hours-content" class="flex-grow overflow-y-auto">
                </div>
        </div>
    </div>
    
    <div id="modal-help" class="fixed inset-0 z-[150] items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl m-4 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center pb-2 mb-4 border-b">
                <h3 class="text-xl font-bold text-gray-800">Guida Rapida</h3>
                <button onclick="closeModal('modal-help')" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
            </div>
            <div class="flex-grow overflow-y-auto pr-2 space-y-4">
                <div>
                    <h4 class="font-bold text-lg text-indigo-600 mb-2">Operazioni Base</h4>
                    <div class="space-y-2">
                         <details class="help-item">
                            <summary>Come cambio un turno?</summary>
                            <p>Clicca sulla cella del giorno e della persona che ti interessa. Si aprirà un piccolo menù. Clicca su "Cambio Turno" e scegli il nuovo turno dalla lista. In alternativa, fai un doppio click sulla cella per un cambio ancora più rapido.</p>
                        </details>
                        <details class="help-item">
                            <summary>Come scambio i turni tra due persone?</summary>
                            <p>Clicca sulla prima cella, scegli "Scambio" dal menù. La cella si illuminerà. Ora clicca sulla seconda cella (anche di un'altra persona) per completare lo scambio.</p>
                        </details>
                        <details class="help-item">
                            <summary>Come assegno le ferie per una settimana?</summary>
                             <p>Clicca e trascina il mouse per selezionare l'intervallo di giorni desiderato. Al rilascio del mouse, si aprirà una finestra: seleziona il turno "F" (Ferie) e clicca "Applica". In alternativa, puoi usare il menù "Periodo" su una singola cella.</p>
                        </details>
                        <details class="help-item">
                            <summary>Ho sbagliato! Come annullo una modifica?</summary>
                            <p>Puoi usare la combinazione di tasti <strong>Ctrl+Z</strong> per annullare l'ultima azione. Per ripristinare, usa <strong>Ctrl+Y</strong>. In alternativa, per una singola cella, clicca, scegli "Ripristina" dal menù per tornare al turno automatico di matrice.</p>
                        </details>
                    </div>
                </div>
                 <div>
                    <h4 class="font-bold text-lg text-indigo-600 mb-2">Cose da Esperti</h4>
                    <div class="space-y-2">
                        <details class="help-item">
                            <summary>Cosa sono i bordi rossi e le icone di allarme?</summary>
                            <p>Indicano una <strong>violazione delle regole</strong> di pianificazione (es. riposo insufficiente, troppi giorni di lavoro). Passa il mouse sull'icona di allarme per vedere quale regola specifica è stata violata. Cerca di risolvere queste violazioni per avere un piano turni valido.</p>
                        </details>
                        <details class="help-item">
                            <summary>Cosa sono i simboli colorati (C, S, G, N...)?</summary>
                            <p>Sono indicatori veloci: <strong>C</strong> (blu) è un Cambio, <strong>S</strong> (arancione) uno Scambio, <strong>G</strong> (giallo) un Gettone. Una <strong>N</strong> nera indica una Nota. Un <strong>+</strong> rosso indica ore di Straordinario.</p>
                        </details>
                        <details class="help-item">
                            <summary>Come si assegnano gli incarichi (es. RUBINO)?</summary>
                            <p>Apri il menu laterale e clicca il pulsante viola "Assegna Incarichi". La griglia cambierà aspetto. Clicca su una cella e si aprirà una palette di colori/incarichi. Scegli un colore per "dipingere" la cella. Per tornare alla vista normale, clicca di nuovo su "Assegna Incarichi".</p>
                        </details>
                         <details class="help-item">
                            <summary>Come aggiungo ore extra, rientri o prolungamenti?</summary>
                            <p>Clicca su una cella e scegli "Extra". Nella finestra potrai inserire le ore di straordinario e spuntare le caselle per Rientro, Prolungamento o Gettone.</p>
                        </details>
                    </div>
                </div>
                 <div>
                    <h4 class="font-bold text-lg text-indigo-600 mb-2">Impostazioni e Organizzazione</h4>
                    <div class="space-y-2">
                        <details class="help-item">
                            <summary>Come cambio l'ordine delle persone nella griglia?</summary>
                            <p>Tieni premuto il click sul nome di una persona e trascina la riga su o giù. Il nuovo ordine verrà salvato automaticamente.</p>
                        </details>
                        <details class="help-item">
                            <summary>Come aggiungo/modifico una persona o un turno?</summary>
                            <p>Vai su "Impostazioni" nel menu in alto e seleziona la scheda "Elementi di Base". Qui troverai un'interfaccia compatta per gestire Operatori, Turni, Incarichi, Motivi e Matrici senza dover aprire finestre separate.</p>
                        </details>
                        <details class="help-item">
                            <summary>Come salvo o carico le mie impostazioni?</summary>
                            <p>Nella vista "Impostazioni", nella sezione "Gestione Dati", puoi usare i pulsanti "Salva Stato Completo" (crea un file .json) e "Carica Stato Completo" (carica un file .json salvato in precedenza).</p>
                        </details>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Modifica Notifica -->
    <div id="modal-edit-notification" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">Modifica Notifica</h3>
                <button id="close-edit-notification" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
            </div>
            
            <div class="space-y-6">
                <!-- Informazioni Notifica -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-gray-700 mb-2">Informazioni Notifica</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="font-medium text-gray-600">Operatore:</span>
                            <span id="edit-notification-operator" class="ml-2"></span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">Data:</span>
                            <span id="edit-notification-date" class="ml-2"></span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">Tipo:</span>
                            <span id="edit-notification-type" class="ml-2"></span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">Stato:</span>
                            <span id="edit-notification-status" class="ml-2"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Modifica Turno -->
                <div class="border border-blue-200 rounded-lg p-4">
                    <h4 class="font-semibold text-blue-700 mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" />
                        </svg>
                        Modifica Turno
                    </h4>
                    <div class="space-y-3">
                        <div>
                            <label for="edit-notification-shift" class="block text-sm font-medium text-gray-700 mb-1">Nuovo Turno</label>
                            <select id="edit-notification-shift" class="modal-input">
                                <option value="">Mantieni turno attuale</option>
                            </select>
                        </div>
                        <div>
                            <label for="edit-notification-shift-reason" class="block text-sm font-medium text-gray-700 mb-1">Motivo del cambio</label>
                            <select id="edit-notification-shift-reason" class="modal-input">
                                <option value="">Seleziona motivo</option>
                                <option value="malattia">Malattia</option>
                                <option value="ferie">Ferie</option>
                                <option value="emergenza">Emergenza</option>
                                <option value="sostituzione">Sostituzione</option>
                                <option value="altro">Altro</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Modifica Orari -->
                <div class="border border-green-200 rounded-lg p-4">
                    <h4 class="font-semibold text-green-700 mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Modifica Orari
                    </h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="edit-notification-start-time" class="block text-sm font-medium text-gray-700 mb-1">Ora Inizio</label>
                            <input type="time" id="edit-notification-start-time" class="modal-input">
                        </div>
                        <div>
                            <label for="edit-notification-end-time" class="block text-sm font-medium text-gray-700 mb-1">Ora Fine</label>
                            <input type="time" id="edit-notification-end-time" class="modal-input">
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="flex items-center text-sm text-gray-700">
                            <input type="checkbox" id="edit-notification-overtime" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-2">
                            Straordinario
                        </label>
                    </div>
                </div>
                
                <!-- Note e Commenti -->
                <div class="border border-yellow-200 rounded-lg p-4">
                    <h4 class="font-semibold text-yellow-700 mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        Note e Commenti
                    </h4>
                    <div class="space-y-3">
                        <div>
                            <label for="edit-notification-note" class="block text-sm font-medium text-gray-700 mb-1">Nota</label>
                            <textarea id="edit-notification-note" rows="3" class="modal-input" placeholder="Aggiungi una nota per questa notifica..."></textarea>
                        </div>
                        <div>
                            <label for="edit-notification-internal-comment" class="block text-sm font-medium text-gray-700 mb-1">Commento Interno</label>
                            <textarea id="edit-notification-internal-comment" rows="2" class="modal-input" placeholder="Commento visibile solo al personale amministrativo..."></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Opzioni Aggiuntive -->
                <div class="border border-purple-200 rounded-lg p-4">
                    <h4 class="font-semibold text-purple-700 mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        Opzioni Aggiuntive
                    </h4>
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="edit-notification-priority" class="block text-sm font-medium text-gray-700 mb-1">Priorità</label>
                                <select id="edit-notification-priority" class="modal-input">
                                    <option value="normale">Normale</option>
                                    <option value="alta">Alta</option>
                                    <option value="urgente">Urgente</option>
                                    <option value="bassa">Bassa</option>
                                </select>
                            </div>
                            <div>
                                <label for="edit-notification-notification-type" class="block text-sm font-medium text-gray-700 mb-1">Tipo Notifica</label>
                                <select id="edit-notification-notification-type" class="modal-input">
                                    <option value="cambio">Cambio Turno</option>
                                    <option value="extra">Ore Extra</option>
                                    <option value="sostituzione">Sostituzione</option>
                                    <option value="emergenza">Emergenza</option>
                                    <option value="ferie">Ferie</option>
                                    <option value="malattia">Malattia</option>
                                </select>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="flex items-center text-sm text-gray-700">
                                <input type="checkbox" id="edit-notification-gettone" class="h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500 mr-2">
                                Attiva gettone di chiamata
                            </label>
                            <label class="flex items-center text-sm text-gray-700">
                                <input type="checkbox" id="edit-notification-confirmed" class="h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500 mr-2">
                                Confermata dall'operatore
                            </label>
                            <label class="flex items-center text-sm text-gray-700">
                                <input type="checkbox" id="edit-notification-send-sms" class="h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500 mr-2">
                                Invia notifica SMS
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Pulsanti Azione -->
            <div class="mt-8 flex justify-end gap-3">
                <button id="cancel-edit-notification" class="btn-3d btn-gray">Annulla</button>
                <button id="delete-notification" class="btn-3d btn-red">Elimina</button>
                <button id="save-edit-notification" class="btn-3d btn-blue">Salva Modifiche</button>
            </div>
        </div>
    </div>
    
    <div id="operator-info-panel">
        <div id="operator-info-header">
            <h3 id="operator-info-title"></h3>
            <button id="operator-info-close-btn">&times;</button>
        </div>
        <div id="operator-info-content"></div>
    </div>

    <!-- NUOVO MODALE PER LE INDISPONIBILITA' -->
    <div id="modal-unavailability" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl m-4">
            <h3 class="text-lg font-bold mb-4" id="unavailability-modal-title">Gestisci Indisponibilità</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-semibold text-gray-700 mb-2">Aggiungi Nuova</h4>
                    <form id="form-unavailability" class="space-y-3">
                        <input type="hidden" id="unavailability-op-id">
                        <input type="hidden" id="unavailability-id">
                        <div>
                            <label for="unavailability-start-date" class="block text-sm font-medium text-gray-700">Data Inizio</label>
                            <input type="date" id="unavailability-start-date" required class="modal-input">
                        </div>
                        <div>
                            <label for="unavailability-end-date" class="block text-sm font-medium text-gray-700">Data Fine</label>
                            <input type="date" id="unavailability-end-date" required class="modal-input">
                        </div>
                        <div>
                            <label for="unavailability-reason" class="block text-sm font-medium text-gray-700">Motivo</label>
                            <input type="text" id="unavailability-reason" required class="modal-input" placeholder="Es. Visita medica, Congedo...">
                        </div>
                        <div class="pt-2">
                            <button type="submit" id="save-unavailability-btn" class="btn-3d btn-indigo w-full">Salva Indisponibilità</button>
                        </div>
                    </form>
                </div>
                <div>
                    <h4 class="font-semibold text-gray-700 mb-2">Periodi Registrati</h4>
                    <div id="unavailability-list" class="max-h-60 overflow-y-auto border rounded-lg p-2 bg-gray-50">
                        <!-- Elenco delle indisponibilità verrà inserito qui -->
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button onclick="closeModal('modal-unavailability')" class="btn-3d btn-gray">Chiudi</button>
            </div>
        </div>
    </div>

    <!-- NUOVO MODALE PER I SUGGERIMENTI -->
    <div id="modal-suggestion" class="fixed z-50 items-center justify-center hidden modal-backdrop">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg m-4 flex flex-col">
            <div class="p-4 border-b modal-header-draggable">
                <h3 class="text-lg font-bold" id="suggestion-modal-title">Suggerimenti Copertura</h3>
            </div>
            <div id="suggestion-list" class="p-2">
                <!-- Elenco dei suggerimenti verrà inserito qui -->
            </div>
             <div class="mt-auto p-4 border-t flex justify-end">
                <button onclick="closeModal('modal-suggestion')" class="btn-3d btn-gray">Chiudi</button>
            </div>
        </div>
    </div>
<!-- ================================================================= -->
<!-- ========= NUOVO MODALE PER CONFERMA CAMBIO ORDINAMENTO ========== -->
<!-- ================================================================= -->
<div id="modal-order-change" class="fixed inset-0 z-[100] items-center justify-center hidden modal-backdrop">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg m-4">
        <h3 class="text-lg font-bold mb-4">Conferma Spostamento Operatore</h3>
        <p id="order-change-summary" class="text-sm text-gray-700 bg-gray-50 p-3 rounded-md border mb-4"></p>
        
        <div class="space-y-4">
            <div>
                <label class="form-field-label">Tipo di Spostamento</label>
                <div class="space-y-2 text-sm">
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-400">
                        <input type="radio" name="order-change-type" value="swap_schedule" class="h-4 w-4" checked>
                        <span class="ml-3">
                            <strong class="block">Sposta e Scambia Turno di Matrice</strong>
                            <span class="text-gray-600">L'operatore eredita lo schema di turni della nuova posizione.</span>
                        </span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-400">
                        <input type="radio" name="order-change-type" value="swap_position">
                        <span class="ml-3">
                            <strong class="block">Sposta solo la Posizione Visiva</strong>
                            <span class="text-gray-600">L'operatore mantiene il suo schema di turni originale.</span>
                        </span>
                    </label>
                </div>
            </div>
            <div>
                <label for="order-change-start-date" class="form-field-label">Applica a partire da</label>
                <input type="month" id="order-change-start-date" class="modal-input">
            </div>
            <div>
                <label for="order-change-name" class="form-field-label">Nome dello Schema di Rotazione (es. Rotazione Estiva)</label>
                <input type="text" id="order-change-name" class="modal-input" required>
            </div>
        </div>

        <div class="mt-6 flex justify-end gap-3">
            <button id="cancel-order-change" class="btn-3d btn-gray">Annulla</button>
            <button id="confirm-order-change" class="btn-3d btn-indigo">Crea Nuovo Schema</button>
        </div>
    </div>
</div>
    <div id="print-legend" class="print-only">
        <h4 class="print-legend-title">Legenda Turni</h4>
        <div id="print-legend-content"></div>
    </div>

    <div id="toast-container" class="fixed bottom-4 right-4 z-[200] flex flex-col gap-2 items-end"></div>
    
    <!-- Modal per riepilogo giornaliero -->
    <div id="modal-day-summary" class="hidden fixed z-40 bg-white rounded-lg shadow-xl border p-4 w-full max-w-7xl">
        <div class="modal-day-summary-header pb-2 mb-3 border-b modal-header-draggable">
            <div id="day-summary-nav-title" class="font-bold text-lg"></div>
            <div id="day-summary-alert" class="flex-grow"></div>
            <button id="close-day-summary" class="text-gray-400 hover:text-gray-600 text-2xl leading-none ml-4 no-drag">&times;</button>
        </div>
        <div id="day-summary-content"></div>
    </div>
    
    <!-- ================================================================= -->
    <!-- ELEMENTI PER IL SISTEMA DI EMERGENZA E BACKUP -->
    <!-- ================================================================= -->

    <!-- Alert Principale di Emergenza (inizialmente nascosto) -->
    <div id="emergency-alert-container" class="hidden fixed top-5 left-1/2 -translate-x-1/2 z-[160] bg-red-600 text-white p-4 rounded-lg shadow-2xl border-2 border-red-300 w-full max-w-md animate-pulse">
        <div class="flex items-start gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
            <div>
                <h4 class="font-bold">ALLARME DI SISTEMA</h4>
                <p id="emergency-alert-message" class="text-sm mt-1"></p>
                <div class="mt-3 flex justify-end gap-2">
                    <button id="emergency-dismiss-btn" class="text-xs font-semibold py-1 px-3 bg-red-700 hover:bg-red-800 rounded">Ignora</button>
                    <button id="emergency-resolve-btn" class="text-xs font-semibold py-1 px-3 bg-white text-red-600 hover:bg-red-100 rounded">Risolvi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert per Copertura Critica (DISABILITATO PERMANENTEMENTE) -->
        <div id="critical-coverage-alert" class="hidden fixed top-20 right-5 z-[155] bg-orange-500 text-white p-4 rounded-lg shadow-xl border-2 border-orange-300 w-full max-w-sm" style="display: none !important;">
        <div class="flex items-start gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.707-10.293a1 1 0 00-1.414-1.414L9 7.586V13a1 1 0 102 0V7.586l.293-.293z" clip-rule="evenodd" /></svg>
            <div>
                 <h4 class="font-bold">Copertura Critica</h4>
                <p id="critical-coverage-message" class="text-sm mt-1"></p>
                 <div class="mt-3 flex justify-end gap-2">
                    <button id="dismiss-coverage-alert" class="text-xs font-semibold py-1 px-3 bg-orange-600 hover:bg-orange-700 rounded">Chiudi</button>
                    <button id="suggest-coverage-btn" class="text-xs font-semibold py-1 px-3 bg-white text-orange-600 hover:bg-orange-100 rounded">Suggerisci</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard di Monitoraggio Emergenze -->
    <div id="emergency-dashboard" class="fixed top-20 right-4 w-80 bg-white rounded-lg shadow-lg border-2 border-gray-200 z-50 hidden">
        <div class="bg-gradient-to-r from-red-500 to-red-600 text-white p-3 rounded-t-lg">
            <div class="flex items-center justify-between">
                <h3 class="font-bold text-sm flex items-center gap-2">
                    <span class="text-lg">🚨</span>
                    Monitoraggio Emergenze
                </h3>
                <button id="toggle-emergency-dashboard" class="text-white hover:text-gray-200 text-lg font-bold">
                    ×
                </button>
            </div>
        </div>
        
        <div class="p-4 space-y-4">
            <!-- Stato Generale -->
            <div class="bg-gray-50 p-3 rounded-lg">
                <h4 class="font-semibold text-xs text-gray-600 mb-2">STATO GENERALE</h4>
                <div id="emergency-status" class="flex items-center gap-2">
                    <div id="status-indicator" class="w-3 h-3 rounded-full bg-green-500"></div>
                    <span id="status-text" class="text-sm font-medium">Sistema Normale</span>
                </div>
            </div>
            
            <!-- Metriche Critiche -->
            <div class="space-y-3">
                <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                    <h4 class="font-semibold text-xs text-yellow-700 mb-2">COPERTURA CRITICA</h4>
                    <div id="critical-coverage-metrics" class="space-y-1">
                        <div class="flex justify-between text-sm">
                            <span>Mattino:</span>
                            <span id="morning-deficit" class="font-medium">0</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Pomeriggio:</span>
                            <span id="afternoon-deficit" class="font-medium">0</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Notte:</span>
                            <span id="night-deficit" class="font-medium">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-red-50 p-3 rounded-lg border border-red-200">
                    <h4 class="font-semibold text-xs text-red-700 mb-2">VIOLAZIONI ATTIVE</h4>
                    <div id="active-violations" class="space-y-1">
                        <div class="flex justify-between text-sm">
                            <span>Riposo insufficiente:</span>
                            <span id="rest-violations" class="font-medium text-red-600">0</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Giorni consecutivi:</span>
                            <span id="consecutive-violations" class="font-medium text-red-600">0</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Ore eccessive:</span>
                            <span id="hours-violations" class="font-medium text-red-600">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                    <h4 class="font-semibold text-xs text-blue-700 mb-2">OPERATORI DISPONIBILI</h4>
                    <div id="available-operators" class="space-y-1">
                        <div class="flex justify-between text-sm">
                            <span>Riposo oggi:</span>
                            <span id="rest-today" class="font-medium text-blue-600">0</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Qualità alta (>8):</span>
                            <span id="high-quality" class="font-medium text-blue-600">0</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Azioni Rapide -->
            <div class="border-t pt-3">
                <h4 class="font-semibold text-xs text-gray-600 mb-2">AZIONI RAPIDE</h4>
                <div class="space-y-2">
                    <button id="auto-resolve-coverage" class="w-full bg-orange-500 hover:bg-orange-600 text-white text-xs font-medium py-2 px-3 rounded transition-colors">
                        🔧 Risolvi Copertura Automaticamente
                    </button>
                    <button id="emergency-backup" class="w-full bg-red-500 hover:bg-red-600 text-white text-xs font-medium py-2 px-3 rounded transition-colors">
                        💾 Backup di Emergenza
                    </button>
                    <button id="reset-violations" class="w-full bg-gray-500 hover:bg-gray-600 text-white text-xs font-medium py-2 px-3 rounded transition-colors">
                        🔄 Reset Violazioni
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Backup Management Panel -->
    <div id="backup-panel" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md bg-white rounded-lg shadow-2xl border z-50 hidden">
        <div class="bg-blue-500 text-white p-3 rounded-t-lg flex justify-between items-center">
            <h3 class="font-semibold text-sm">Gestione Backup</h3>
            <button id="close-backup-panel" class="text-white hover:text-gray-200 text-lg font-bold">×</button>
        </div>
        <div class="p-4 space-y-4">
            <!-- Stato -->
            <div class="bg-gray-50 p-3 rounded-lg">
                <h4 class="font-semibold text-xs text-gray-600 mb-2">STATO</h4>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <span>Stato: <b id="backup-status-text">Attivo</b></span>
                    <span>Totali: <b id="backup-count">0</b></span>
                    <span>Ultimo: <b id="backup-last-time">Mai</b></span>
                    <span>Prossimo: <b id="backup-next-time">--</b></span>
                </div>
            </div>
            <!-- Controlli -->
            <div class="grid grid-cols-3 gap-2">
                <button id="btn-manual-backup" class="btn-3d btn-indigo text-xs py-2">Backup Ora</button>
                <button id="btn-toggle-auto-backup" class="btn-3d btn-gray text-xs py-2">Pausa</button>
                <button id="btn-backup-settings" class="btn-3d btn-gray text-xs py-2">Impostazioni</button>
            </div>
        </div>
    </div>

    <!-- Backup Settings Modal -->
    <div id="backup-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-60 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm">
            <div class="bg-gray-100 p-3 rounded-t-lg flex justify-between items-center">
                <h3 class="font-semibold text-sm">Impostazioni Backup</h3>
                <button id="close-backup-settings" class="text-gray-500 hover:text-gray-700 text-lg font-bold">×</button>
            </div>
            <div class="p-4 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Intervallo (minuti)</label>
                    <input type="number" id="backup-interval" class="modal-input">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">N. max backup da conservare</label>
                    <input type="number" id="backup-max-count" class="modal-input">
                </div>
                <label class="flex items-center text-sm">
                    <input type="checkbox" id="backup-emergency-enabled" class="h-4 w-4 rounded border-gray-300 mr-2">
                    <span>Backup automatico in emergenza</span>
                </label>
                 <label class="flex items-center text-sm">
                    <input type="checkbox" id="backup-pre-operation" class="h-4 w-4 rounded border-gray-300 mr-2">
                    <span>Abilita backup automatici</span>
                </label>
            </div>
            <div class="p-3 bg-gray-50 border-t flex gap-2 justify-end">
                <button id="btn-cancel-backup-settings" class="btn-3d btn-gray text-sm">Annulla</button>
                <button id="btn-save-backup-settings" class="btn-3d btn-indigo text-sm">Salva</button>
            </div>
        </div>
    </div>


    <script src="script.js"></script>

</body>
</html>
